<div class="container">
  <div class="header">
    <div class="welcome-message">
      <h1>Bienvenido, {{user.first_name}} {{user.last_name}}</h1>
      <div class="user-info">
        <p><strong>Email:</strong> {{user.email}}</p>
        <p><strong>Edad:</strong> {{user.age}} a√±os</p>
        <p class="role {{user.role}}">
          <strong>Rol:</strong> 
          {{#if (eq user.role 'admin')}}
            üëë Administrador
          {{else}}
            üë§ Usuario
          {{/if}}
        </p>
      </div>
    </div>
    <button id="logoutBtn" class="btn-secondary">Cerrar Sesi√≥n</button>
  </div>

  <div class="products-section">
    <div class="section-header">
      <h2>Cat√°logo de Productos</h2>
      <a href="/cart" class="btn-primary">üõí Ver Carrito</a>
    </div>
    <div id="productsGrid" class="products-grid">
      <p>Cargando productos...</p>
    </div>
  </div>
</div>

<script>
  // Helper para comparar valores
  Handlebars.registerHelper('eq', function(a, b) {
    return a === b;
  });

  // Verificar si hay token en la URL (GitHub OAuth)
  const urlParams = new URLSearchParams(window.location.search);
  const tokenFromUrl = urlParams.get('token');
  if (tokenFromUrl) {
    localStorage.setItem('token', tokenFromUrl);
    // Limpiar URL
    window.history.replaceState({}, document.title, '/products');
  }

  // Funci√≥n para obtener el token
  function getToken() {
    return localStorage.getItem('token');
  }

  // Verificar token al cargar
  const token = getToken();
  console.log('üîç Token check:', token ? '‚úì Presente' : '‚úó No presente');
  
  if (!token) {
    document.getElementById('productsGrid').innerHTML = `
      <div class="error-message">
        <p>‚ö†Ô∏è No hay sesi√≥n activa</p>
        <p>Por favor <a href="/login" style="color: #007bff; text-decoration: underline;">inicia sesi√≥n</a></p>
      </div>
    `;
  }

  // Cargar productos
  async function loadProducts() {
    try {
      const response = await fetch('/api/products');
      const data = await response.json();
      
      if (data.status === 'success') {
        displayProducts(data.products);
      }
    } catch (error) {
      console.error('Error cargando productos:', error);
      document.getElementById('productsGrid').innerHTML = 
        '<p class="error-message">Error al cargar productos</p>';
    }
  }

  function displayProducts(products) {
    const grid = document.getElementById('productsGrid');
    
    if (products.length === 0) {
      grid.innerHTML = '<p>No hay productos disponibles</p>';
      return;
    }

    grid.innerHTML = products.map(product => `
      <div class="product-card">
        <h3>${product.name}</h3>
        <p class="price">$${product.price}</p>
        <p class="stock">Stock: ${product.stock} unidades</p>
        <button class="btn-primary" onclick="addToCart('${product._id}')">
          Agregar al carrito
        </button>
      </div>
    `).join('');
  }

  function addToCart(productId) {
    const token = getToken();
    
    if (!token) {
      alert('‚ùå No est√°s autenticado. Recarga la p√°gina.');
      window.location.href = '/login';
      return;
    }
    
    const quantity = prompt('¬øCu√°ntas unidades deseas agregar?', '1');
    
    if (!quantity || quantity < 1) {
      return;
    }

    fetch('/api/cart/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        productId,
        quantity: parseInt(quantity)
      })
    })
    .then(response => {
      if (!response.ok) {
        console.error('Response status:', response.status);
        return response.json().then(data => {
          throw new Error(data.message || 'Error al agregar al carrito');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.status === 'success') {
        alert('‚úì Producto agregado al carrito');
      } else {
        alert('Error: ' + (data.message || 'Error desconocido'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('‚ùå ' + error.message);
    });
  }

  // Cerrar sesi√≥n
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      const response = await fetch('/api/users/logout', {
        method: 'POST'
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        window.location.href = data.redirect || '/login';
      }
    } catch (error) {
      console.error('Error al cerrar sesi√≥n:', error);
      window.location.href = '/login';
    }
  });

  // Cargar productos al iniciar
  loadProducts();
</script>

<style>
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .section-header h2 {
    margin: 0;
  }

  .section-header a {
    padding: 0.75rem 1.5rem;
    background: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: bold;
    transition: background 0.3s;
  }

  .section-header a:hover {
    background: #218838;
  }
</style>