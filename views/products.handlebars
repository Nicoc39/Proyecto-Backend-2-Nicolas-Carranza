<div class="products-container">
  <!-- Navbar Superior Minimalista -->
  <nav class="products-navbar">
    <div class="navbar-brand">
      <div class="brand-logo">
        <div class="logo-bg">
          <img class="logo-img" src="https://i.imgur.com/oFIPJbi.jpeg" alt="NUBE NEGRA logo">
        </div>
        <!-- El logo ya incluye el nombre, no mostrar texto adicional -->
      </div>
    </div>
    <div class="navbar-user" id="userBadge">
      <span class="user-loading">Cargando...</span>
    </div>
    <div class="navbar-actions">
      <button id="adminBtn" class="nav-btn" onclick="window.location.href='/admin/products'" title="Admin productos" style="display: none;">
        üß∞
      </button>
      <button id="profileBtn" class="nav-btn" onclick="window.location.href='/current'" title="Mi perfil">
        üë§
      </button>
      <button id="cartBtn" class="nav-btn" onclick="window.location.href='/cart'" title="Ver carrito">
        üõí
      </button>
      <button id="logoutBtn" class="nav-btn" title="Cerrar sesi√≥n">
        üö™
      </button>
    </div>
  </nav>

  <!-- Hero Section -->
  <div class="products-hero">
    <div class="hero-content">
      <h1>Explor√° nuestro cat√°logo</h1>
      <p>Libros para cada lector y cada momento</p>
    </div>
  </div>

  <!-- Grid de Productos -->
  <div class="products-main">
    <div id="productsGrid" class="products-grid">
      <p class="loading-text">Cargando productos...</p>
    </div>
  </div>

  <!-- Notificaci√≥n -->
  <div id="notification" class="notification"></div>
</div>

<script>
  // Verificar si hay token en la URL (GitHub OAuth)
  const urlParams = new URLSearchParams(window.location.search);
  const tokenFromUrl = urlParams.get('token');
  if (tokenFromUrl) {
    localStorage.setItem('token', tokenFromUrl);
    window.history.replaceState({}, document.title, '/products');
  }

  // Funci√≥n para obtener el token
  function getToken() {
    const token = localStorage.getItem('token');
    console.log('üîë Token:', token ? 'Existe' : 'No existe');
    return token;
  }

  // Funci√≥n para mostrar notificaci√≥n
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }

  // Cargar informaci√≥n del usuario desde JWT
  async function loadUserInfo() {
    const token = getToken();
    
    if (!token) {
      console.log('‚ùå No hay token, redirigiendo a login...');
      showNotification('No est√°s autenticado. Redirigiendo...', 'error');
      setTimeout(() => {
        window.location.href = '/login';
      }, 1500);
      return null;
    }

    try {
      console.log('üë§ Obteniendo informaci√≥n del usuario...');
      const response = await fetch('/api/sessions/current', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        console.log('‚úì Usuario cargado:', data.user);
        displayUserInfo(data.user);
        return data.user;
      } else {
        console.error('‚ùå Error obteniendo usuario:', response.status);
        
        if (response.status === 401) {
          showNotification('Sesi√≥n expirada. Redirigiendo a login...', 'error');
          localStorage.removeItem('token');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } else {
          showNotification('Error al cargar informaci√≥n del usuario', 'error');
        }
        return null;
      }
    } catch (error) {
      console.error('‚ùå Error de red:', error);
      showNotification('Error de conexi√≥n', 'error');
      return null;
    }
  }

  // Mostrar informaci√≥n del usuario
  function displayUserInfo(user) {
    const userBadge = document.getElementById('userBadge');
    const adminBtn = document.getElementById('adminBtn');
    
    const roleIcon = user.role === 'admin' ? 'üëë' : 'üë§';
    const roleText = user.role === 'admin' ? 'Administrador' : 'Usuario';

    if (adminBtn) {
      adminBtn.style.display = user.role === 'admin' ? 'inline-flex' : 'none';
    }
    
    userBadge.innerHTML = `
      <span class="user-name">${user.first_name} ${user.last_name}</span>
      <span class="user-role">${roleIcon} ${roleText}</span>
    `;
  }

  // Cargar productos
  async function loadProducts() {
    try {
      console.log('üì¶ Cargando productos...');
      const response = await fetch('/api/products');
      const data = await response.json();
      
      if (data.status === 'success') {
        console.log('‚úì Productos cargados:', data.products.length);
        displayProducts(data.products);
      }
    } catch (error) {
      console.error('‚ùå Error cargando productos:', error);
      document.getElementById('productsGrid').innerHTML = 
        '<p class="error-message">Error al cargar productos</p>';
    }
  }

  function displayProducts(products) {
    const grid = document.getElementById('productsGrid');
    
    if (products.length === 0) {
      grid.innerHTML = '<p>No hay productos disponibles</p>';
      return;
    }

    grid.innerHTML = products.map(product => {
      console.log('üì¶ Producto:', product);
      console.log('üì∏ Thumbnail:', product.thumbnail);
      console.log('üìù Descripci√≥n:', product.description);
      return `
      <div class="product-card">
        <div class="product-card-image" style="${product.thumbnail && product.thumbnail.trim() !== '' ? `--thumb-url: url('${product.thumbnail}')` : ''}">
          ${product.thumbnail && product.thumbnail.trim() !== '' ? `<img class="product-thumb" src="${product.thumbnail}" alt="${product.name}" onerror="this.parentElement.textContent='üìñ'">` : 'üìñ'}
        </div>
        <h3>${product.name}</h3>
        ${product.author && product.author.trim() !== '' ? `<p class="author"><strong>Autor:</strong> ${product.author}</p>` : ''}
        ${product.category ? `<p class="category"><strong>Categor√≠a:</strong> ${product.category}</p>` : ''}
        <p class="description">${product.description && product.description.trim() !== '' ? product.description : 'Sin descripci√≥n'}</p>
        <p class="price">$${product.price.toFixed(2)}</p>
        ${product.stock > 0
          ? `<p class="stock">‚úì ${product.stock} disponibles</p>
             <button class="btn-primary" onclick="addToCart('${product._id}')">
               Agregar al Carrito
             </button>`
          : `<p class="stock stock-out">Sin stock</p>`}
      </div>
    `;
    }).join('');
    
    console.log('‚úì Productos renderizados');
  }

  // Funci√≥n para agregar al carrito
  async function addToCart(productId) {
    const token = getToken();
    
    if (!token) {
      showNotification('Debes iniciar sesi√≥n para agregar productos', 'error');
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
      return;
    }

    console.log('üõí Agregando producto al carrito:', productId);

    try {
      const response = await fetch('/api/carts/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          productId: productId,
          quantity: 1
        })
      });

      const data = await response.json();

      if (response.ok) {
        console.log('‚úì Producto agregado:', data);
        showNotification('Producto agregado al carrito', 'success');
      } else {
        console.error('‚ùå Error del servidor:', data);
        
        if (response.status === 401) {
          showNotification('Sesi√≥n expirada. Redirigiendo a login...', 'error');
          localStorage.removeItem('token');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } else {
          showNotification(data.message || 'Error al agregar al carrito', 'error');
        }
      }
    } catch (error) {
      console.error('‚ùå Error de red:', error);
      showNotification('Error de conexi√≥n', 'error');
    }
  }

  // Cerrar sesi√≥n
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      console.log('üö™ Cerrando sesi√≥n...');
      
      const response = await fetch('/api/sessions/logout', {
        method: 'POST'
      });
      
      // Eliminar token de localStorage
      localStorage.removeItem('token');
      console.log('‚úì Token eliminado');
      
      if (response.ok) {
        const data = await response.json();
        console.log('‚úì Sesi√≥n cerrada');
        window.location.href = data.redirect;
      } else {
        // Incluso si hay error, redirigir a login
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('‚ùå Error al cerrar sesi√≥n:', error);
      // En caso de error, de todos modos redirigir
      window.location.href = '/login';
    }
  });

  // Inicializar aplicaci√≥n
  async function init() {
    console.log('üöÄ Inicializando aplicaci√≥n...');
    
    // Primero cargar informaci√≥n del usuario
    const user = await loadUserInfo();
    
    if (user) {
      // Si el usuario est√° autenticado, cargar productos
      loadProducts();
    }
  }

  // Ejecutar al cargar la p√°gina
  init();
</script>

<style>
.loading {
  padding: 20px;
  text-align: center;
  color: #666;
  font-style: italic;
}

.notification {
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 8px;
  font-weight: 600;
  z-index: 1000;
  animation: slideIn 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.notification.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.notification.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.user-info .role {
  display: inline-block;
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: 600;
  margin-top: 8px;
}

.user-info .role.admin {
  background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
  color: #856404;
}

.user-info .role.user {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
}
</style>
